<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LendingMaster Pro | Financial Suite v6.1</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* PROFESSIONAL VIBRANT PALETTE */
            --bg-dark: #0f111a;       
            --bg-panel: #161b2c;       
            --bg-input: #1f2940;
            
            --primary: #3b82f6;       
            --primary-vibrant: #2563eb;
            --primary-glow: rgba(59, 130, 246, 0.5);
            
            --text-main: #ffffff;     
            --text-muted: #94a3b8;    
            
            --success: #10b981;
            --danger: #ef4444; /* VIBRANT RED */
            --danger-hover: #dc2626;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- GLASS & CARDS --- */
        .glass-panel {
            background: rgba(22, 27, 44, 0.95);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .stat-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(59, 130, 246, 0.3); }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
        }
        .border-blue::before { background: var(--primary); }
        .border-green::before { background: var(--success); }
        .border-yellow::before { background: var(--warning); }
        .border-red::before { background: var(--danger); }

        .stat-value { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; margin-top: 5px; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 600; color: var(--text-muted); letter-spacing: 0.5px; }

        /* --- INPUTS --- */
        .form-control, .form-select {
            background-color: var(--bg-input);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        .form-control:focus, .form-select:focus {
            background-color: #263350;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            color: white;
        }
        .form-control::placeholder { color: rgba(255,255,255,0.3); }
        input[type="date"] { color-scheme: dark; }

        /* --- BUTTONS --- */
        .btn-primary-pro {
            background: linear-gradient(135deg, var(--primary), var(--primary-vibrant));
            color: white; border: none; padding: 12px 20px;
            border-radius: 8px; font-weight: 600;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            transition: all 0.3s;
        }
        .btn-primary-pro:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5); }
        
        /* White Create Account Button */
        .btn-white-pro {
            background: white;
            color: var(--bg-dark);
            border: none; padding: 12px 20px;
            border-radius: 8px; font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        .btn-white-pro:hover { background: #f0f0f0; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2); }

        /* --- ANIMATED DELETE BUTTON --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .btn-delete-animate {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            transition: 0.3s;
        }
        .btn-delete-animate:hover {
            background: var(--danger);
            color: white;
            box-shadow: 0 0 15px var(--danger);
            animation: shake 0.5s;
            cursor: pointer;
        }

        /* --- AUTH SECTION --- */
        #auth-section {
            height: 100vh; display: flex; align-items: center; justify-content: center;
            position: fixed; width: 100%; z-index: 1000; background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15), transparent 70%);
        }
        .login-card {
            width: 100%; max-width: 450px; padding: 40px; text-align: center;
        }
        
        /* Steps in Registration */
        .step-indicator { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .step-title { color: white; font-weight: 700; margin-bottom: 15px; }

        /* --- TABLE & LISTS --- */
        .custom-table th { background: #111521; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .custom-table td { background: var(--bg-panel); padding: 15px; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .custom-table tr:hover td { background: #1c233a; cursor: pointer; }

        /* --- TIMER --- */
        #demo-timer-bar {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.8); border: 1px solid var(--danger);
            color: var(--danger); padding: 10px 20px; border-radius: 50px;
            font-family: 'Courier New', monospace; font-weight: 700;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
            z-index: 2000; display: none; align-items: center; gap: 10px;
        }
        .timer-icon { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- MODAL --- */
        .modal-content { background-color: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1); }
        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .btn-close { filter: invert(1); }
        
        /* --- HISTORY FILTERS --- */
        .history-filter-select {
            background-color: var(--bg-dark);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted);
            font-size: 0.85rem;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="demo-timer-bar">
        <i class="fas fa-clock timer-icon"></i>
        <span>DEMO ENDS IN: <span id="timer-countdown">01:00</span></span>
    </div>

    <section id="auth-section">
        <div class="glass-panel login-card">
            <div class="mb-4">
                <i class="fas fa-hand-holding-dollar fa-3x text-primary"></i>
            </div>
            <h2 class="fw-bold text-white mb-1">LendingMaster</h2>
            <p class="text-muted small mb-4">Financial Management Suite v6.1</p>

            <div id="login-form">
                <div class="text-start mb-3">
                    <label class="small text-muted mb-1">Account Access</label>
                    <input type="email" id="email" class="form-control mb-3" placeholder="Email Address">
                    <input type="password" id="password" class="form-control" placeholder="Password">
                </div>
                <button class="btn-primary-pro w-100 mb-3" onclick="handleLogin()">Secure Login</button>
                <div class="d-flex flex-column gap-2">
                    <button class="btn-white-pro w-100" onclick="showRegStep(1)">
                        <i class="fas fa-user-plus me-2"></i> Create Account
                    </button>
                    <button class="btn btn-link text-white text-decoration-none btn-sm fw-bold" onclick="startDemo()">
                        <i class="fas fa-rocket me-1"></i> Try Demo (1 Min)
                    </button>
                </div>
            </div>

            <div id="reg-container" class="hidden text-start">
                
                <div id="reg-step-1">
                    <div class="step-indicator text-primary">Step 1 of 3: Payment</div>
                    <h5 class="step-title">Subscription Payment</h5>
                    <div class="p-3 rounded mb-3" style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3);">
                        <p class="mb-1 small text-muted">Send payment via GCash:</p>
                        <h4 class="text-white fw-bold mb-0">0948-374-8304</h4>
                        <small class="text-white">Name: AN......LO</small>
                    </div>
                    <button class="btn-primary-pro w-100" onclick="showRegStep(2)">I have sent payment <i class="fas fa-arrow-right ms-2"></i></button>
                    <button class="btn btn-link text-muted w-100 mt-2 text-decoration-none" onclick="showRegStep(0)">Cancel</button>
                </div>

                <div id="reg-step-2" class="hidden">
                    <div class="step-indicator text-warning">Step 2 of 3: Verification</div>
                    <h5 class="step-title">Payment Details</h5>
                    <div class="mb-3">
                        <input type="text" id="reg-ref" class="form-control mb-2" placeholder="GCash Reference No.">
                        <input type="text" id="reg-sender" class="form-control mb-2" placeholder="Sender Name">
                        <input type="text" id="reg-mobile" class="form-control" placeholder="Sender Mobile No.">
                    </div>
                    <button class="btn-primary-pro w-100" onclick="showRegStep(3)">Next Step <i class="fas fa-arrow-right ms-2"></i></button>
                    <button class="btn btn-link text-muted w-100 mt-2 text-decoration-none" onclick="showRegStep(1)">Back</button>
                </div>

                <div id="reg-step-3" class="hidden">
                    <div class="step-indicator text-success">Step 3 of 3: Account</div>
                    <h5 class="step-title">Create Login</h5>
                    <div class="mb-3">
                        <input type="email" id="reg-email" class="form-control mb-2" placeholder="Email Address">
                        <input type="password" id="reg-password" class="form-control" placeholder="Create Password">
                    </div>
                    <button class="btn-primary-pro w-100" onclick="handleSignup()">Submit for Activation</button>
                    <button class="btn btn-link text-muted w-100 mt-2 text-decoration-none" onclick="showRegStep(2)">Back</button>
                </div>

            </div>
        </div>
    </section>

    <section id="dashboard-section" style="display: none;">
        
        <nav class="navbar navbar-expand-lg py-3 mb-4" style="background: rgba(22, 27, 44, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05);">
            <div class="container-fluid px-4">
                <a class="navbar-brand fw-bold text-white d-flex align-items-center" href="#">
                    <i class="fas fa-chart-pie text-primary me-2"></i> LendingMaster <span class="badge bg-danger ms-2" style="font-size: 0.6rem;">PRO</span>
                </a>
                <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" onclick="handleLogout()">Logout</button>
            </div>
        </nav>

        <div class="container-fluid px-4 pb-5">
            
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card border-blue">
                        <div class="stat-label">Total Receivables</div>
                        <div class="stat-value text-primary" id="summaryTotalBalance">₱0</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-green">
                        <div class="stat-label">Total Collected</div>
                        <div class="stat-value text-success" id="summaryTotalPaid">₱0</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-yellow">
                        <div class="stat-label">Capital Out</div>
                        <div class="stat-value text-warning" id="summaryTotalInvestment">₱0</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-red">
                        <div class="stat-label">Proj. Interest</div>
                        <div class="stat-value text-danger" id="summaryTotalInterest">₱0</div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-3 mb-4 d-flex flex-wrap gap-3 align-items-center justify-content-between">
                <div class="flex-grow-1" style="max-width: 400px;">
                    <input type="text" id="filterUtang" class="form-control" placeholder="Search borrower..." onkeyup="filterTable()">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary text-white" onclick="downloadPDF()"><i class="fas fa-print me-2"></i> Report</button>
                    <button class="btn-primary-pro" data-bs-toggle="modal" data-bs-target="#addLoanModal"><i class="fas fa-plus me-2"></i> New Contract</button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-xl-8">
                    <div class="glass-panel h-100 p-0 overflow-hidden">
                        <div class="p-3 border-bottom border-white border-opacity-10 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-white">Active Contracts</h6>
                            <span class="badge bg-success bg-opacity-10 text-success">Live Data</span>
                        </div>
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table custom-table mb-0" id="utangListTable">
                                <thead>
                                    <tr>
                                        <th>Borrower</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th class="text-end">Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="utangListBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4">
                    <div class="glass-panel p-4 mb-4">
                        <h6 class="stat-label mb-3">Cash Flow</h6>
                        <div style="height: 200px;"><canvas id="financeChart"></canvas></div>
                    </div>
                    <div class="glass-panel p-4">
                        <h6 class="stat-label mb-3">Portfolio Health</h6>
                        <div style="height: 200px;"><canvas id="statusChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="addLoanModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">New Contract</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="utangForm">
                        <label class="stat-label mb-1">Borrower Name</label>
                        <input type="text" id="name" class="form-control mb-3" placeholder="Full Name">
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="stat-label mb-1">Principal</label>
                                <input type="number" id="initialLoan" class="form-control" placeholder="0.00">
                            </div>
                            <div class="col-6">
                                <label class="stat-label mb-1">Interest</label>
                                <select id="interestRate" class="form-select">
                                    <option value="0.0">0%</option>
                                    <option value="0.10">10%</option>
                                    <option value="0.20" selected>20%</option>
                                    <option value="0.30">30%</option>
                                    <option value="0.40">40%</option>
                                    <option value="0.50">50%</option>
                                </select>
                            </div>
                        </div>
                        <label class="stat-label mb-1">Date</label>
                        <input type="date" id="loanDate" class="form-control">
                    </form>
                </div>
                <div class="modal-footer p-3">
                    <button type="button" class="btn-primary-pro w-100" onclick="addUtang()">Save Contract</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content overflow-hidden">
                <div class="modal-header p-4">
                    <div>
                        <h4 id="p-name" class="mb-0 fw-bold text-white">Name</h4>
                        <small id="p-date" class="text-muted">Date</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <div class="col-md-5 p-4 bg-dark border-end border-white border-opacity-10">
                            <div class="text-center mb-4 p-3 rounded" style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3);">
                                <small class="text-primary fw-bold text-uppercase">Balance</small>
                                <h2 id="p-balance" class="text-white fw-bold m-0">₱0</h2>
                            </div>

                            <label class="stat-label text-success mb-2">Add Payment</label>
                            <div class="d-flex gap-2 mb-2">
                                <input type="number" id="p-pay-amount" class="form-control" placeholder="Amount">
                                <input type="date" id="p-pay-date" class="form-control" style="width: 60px;">
                            </div>
                            <button class="btn-primary-pro w-100 mb-4" style="background: var(--success);" onclick="executePayment()">Submit Payment</button>

                            <hr class="border-white opacity-10">

                            <label class="stat-label text-danger mb-2">Penalty</label>
                            <div class="input-group mb-4">
                                <input type="number" id="p-penalty-amount" class="form-control" placeholder="Fee">
                                <button class="btn btn-outline-danger" onclick="executePenalty()">Apply</button>
                            </div>

                            <button class="btn-delete-animate" onclick="deleteCurrentProfile()">
                                <i class="fas fa-trash-alt me-2"></i> DELETE RECORD
                            </button>
                        </div>

                        <div class="col-md-7 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="stat-label mb-0">Transaction History</h6>
                                <div class="d-flex gap-2">
                                    <select id="historyFilterType" class="history-filter-select" onchange="renderHistory()">
                                        <option value="all">All Types</option>
                                        <option value="payment">Payments</option>
                                        <option value="penalty">Penalties</option>
                                    </select>
                                    <input type="date" id="historyFilterDate" class="history-filter-select" style="width: 110px;" onchange="renderHistory()">
                                </div>
                            </div>
                            <div style="height: 350px; overflow-y: auto;" id="p-history-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB3lUsTef1DdBhaUfmw0vkYv72MMpPlvBI",
            authDomain: "lendingmaster-e2a58.firebaseapp.com",
            projectId: "lendingmaster-e2a58",
            storageBucket: "lendingmaster-e2a58.firebasestorage.app",
            messagingSenderId: "737470799590",
            appId: "1:737470799590:web:0bb175b1a6e49f54326527",
            measurementId: "G-04X6MKXGW3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let unsubscribeLoans = null;
        let loanData = [];
        let currentProfileId = null;
        let chart1, chart2;

        // --- DEMO LOGIC ---
        window.startDemo = () => {
            const blocked = localStorage.getItem('demoBlocked');
            if (blocked) {
                Swal.fire({icon:'error', title:'Demo Expired', text:'Please subscribe to access.', background:'#161b2c', color:'white'});
                return;
            }

            const demoDuration = 60000; // 1 minute
            localStorage.setItem('demoStart', Date.now());
            
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('demo-timer-bar').style.display = 'flex';
            
            // Initial Mock Data for Demo
            loanData = [
                {id: 'demo1', name: 'Demo User 1', balance: 500, initialLoan: 1000, interest: 200, totalLoan: 1200, loanDate: '2023-01-01', payments: []},
                {id: 'demo2', name: 'Demo User 2', balance: 0, initialLoan: 500, interest: 50, totalLoan: 550, loanDate: '2023-01-02', payments: []}
            ];
            renderAll();

            const timerInterval = setInterval(() => {
                const now = Date.now();
                const start = parseInt(localStorage.getItem('demoStart'));
                const elapsed = now - start;
                const remaining = demoDuration - elapsed;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    localStorage.setItem('demoBlocked', 'true');
                    document.body.innerHTML = "<div style='height:100vh; display:flex; justify-content:center; align-items:center; background:#0f111a; color:white; flex-direction:column;'><h1>DEMO EXPIRED</h1><p>Please contact admin to subscribe.</p></div>";
                } else {
                    const seconds = Math.floor(remaining / 1000);
                    document.getElementById('timer-countdown').innerText = `00:${seconds < 10 ? '0'+seconds : seconds}`;
                }
            }, 1000);
        };

        // --- AUTH LOGIC ---
        window.showRegStep = (step) => {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('reg-container').classList.remove('hidden');
            
            [1, 2, 3].forEach(i => document.getElementById(`reg-step-${i}`).classList.add('hidden'));
            
            if(step === 0) {
                document.getElementById('reg-container').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            } else {
                document.getElementById(`reg-step-${step}`).classList.remove('hidden');
            }
        };

        window.handleSignup = async () => {
            const ref = document.getElementById('reg-ref').value;
            const sender = document.getElementById('reg-sender').value;
            const mobile = document.getElementById('reg-mobile').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            if(!ref || !sender || !mobile || !email || !password) {
                Swal.fire({icon:'warning', title:'Missing Details', text:'Fill all fields.', background:'#161b2c', color:'white'});
                return;
            }

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), {
                    email: email,
                    gcashReference: ref,
                    senderName: sender,
                    senderMobile: mobile,
                    status: 'pending',
                    createdAt: new Date()
                });
                
                Swal.fire({icon:'success', title:'Registered!', text:'Your account is pending activation. Please wait for Admin approval.', background:'#161b2c', color:'white'});
                showRegStep(0);
            } catch (error) {
                Swal.fire({icon:'error', title:'Error', text: error.message, background:'#161b2c', color:'white'});
            }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const cred = await signInWithEmailAndPassword(auth, email, password);
                checkUserStatus(cred.user.uid);
            } catch (error) {
                Swal.fire({icon:'error', title:'Login Failed', text:'Check credentials.', background:'#161b2c', color:'white'});
            }
        };

        async function checkUserStatus(uid) {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                if (data.status === 'active') {
                    currentUser = uid;
                    initDashboard();
                } else {
                    await signOut(auth);
                    Swal.fire({icon:'info', title:'Pending Activation', text:'Admin has not activated this account yet.', background:'#161b2c', color:'white'});
                }
            } else {
                currentUser = uid;
                initDashboard();
            }
        }

        window.handleLogout = async () => {
            if(unsubscribeLoans) unsubscribeLoans();
            await signOut(auth);
            location.reload();
        };

        function initDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';

            const loansRef = collection(db, `users/${currentUser}/loans`);
            unsubscribeLoans = onSnapshot(loansRef, (snapshot) => {
                loanData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        }

        // --- CRUD FUNCTIONS (No flickers) ---
        window.addUtang = async () => {
            const name = document.getElementById('name').value;
            const principal = parseFloat(document.getElementById('initialLoan').value);
            const rate = parseFloat(document.getElementById('interestRate').value);
            const date = document.getElementById('loanDate').value;

            if(!name || !principal || !date) return;

            const interest = principal * rate;
            const total = principal + interest;

            if(currentUser) {
                await setDoc(doc(collection(db, `users/${currentUser}/loans`)), {
                    name, initialLoan: principal, interest, totalLoan: total, balance: total, loanDate: date, payments: []
                });
            } else {
                loanData.push({ id: Date.now(), name, initialLoan: principal, interest, totalLoan: total, balance: total, loanDate: date, payments: [] });
                renderAll();
            }

            bootstrap.Modal.getInstance(document.getElementById('addLoanModal')).hide();
            document.getElementById('utangForm').reset();
            Swal.fire({icon:'success', title:'Saved', toast:true, position:'top-end', showConfirmButton:false, timer:1500, background:'#161b2c', color:'white'});
        };

        window.executePayment = async () => {
            const amount = parseFloat(document.getElementById('p-pay-amount').value);
            const date = document.getElementById('p-pay-date').value;
            if(!amount || !date) return;

            const loan = loanData.find(l => l.id === currentProfileId);
            const newBalance = loan.balance - amount;
            const newPayment = { amount, date, type: 'payment' };
            const updatedPayments = [...(loan.payments || []), newPayment];

            if(currentUser) {
                await updateDoc(doc(db, `users/${currentUser}/loans`, currentProfileId), {
                    balance: newBalance,
                    payments: updatedPayments
                });
            } else {
                loan.balance = newBalance;
                loan.payments = updatedPayments;
            }
            
            // Optimistic UI Update (No flicker)
            updateProfileUI(loan.name, loan.loanDate, newBalance);
            renderHistory();
            document.getElementById('p-pay-amount').value = '';
        };

        window.executePenalty = async () => {
            const amount = parseFloat(document.getElementById('p-penalty-amount').value);
            if(!amount) return;

            const loan = loanData.find(l => l.id === currentProfileId);
            const newBalance = loan.balance + amount;
            const newTotal = loan.totalLoan + amount;
            const newPenalty = { amount, date: new Date().toISOString().split('T')[0], type: 'penalty' };
            const updatedPayments = [...(loan.payments || []), newPenalty];

            if(currentUser) {
                await updateDoc(doc(db, `users/${currentUser}/loans`, currentProfileId), {
                    balance: newBalance,
                    totalLoan: newTotal,
                    payments: updatedPayments
                });
            } else {
                loan.balance = newBalance;
                loan.totalLoan = newTotal;
                loan.payments = updatedPayments;
            }

            // Optimistic UI Update (No flicker)
            updateProfileUI(loan.name, loan.loanDate, newBalance);
            renderHistory();
            document.getElementById('p-penalty-amount').value = '';
        };

        window.deleteCurrentProfile = async () => {
            const result = await Swal.fire({
                title: 'Delete Record?', text: "Permanent Action.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', background:'#161b2c', color:'white'
            });

            if(result.isConfirmed) {
                if(currentUser) {
                    await deleteDoc(doc(db, `users/${currentUser}/loans`, currentProfileId));
                } else {
                    loanData = loanData.filter(l => l.id !== currentProfileId);
                    renderAll();
                }
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            }
        };

        // --- RENDERING ---
        window.renderAll = () => {
            const tbody = document.getElementById('utangListBody');
            tbody.innerHTML = '';
            
            let totalRec = 0, totalCol = 0, totalCap = 0, totalInt = 0;

            loanData.forEach(loan => {
                totalRec += loan.balance;
                totalCap += loan.initialLoan;
                totalInt += loan.interest;
                
                const paid = (loan.payments || []).filter(p => p.type === 'payment').reduce((a,b) => a + b.amount, 0);
                totalCol += paid;

                const percent = ((loan.totalLoan - loan.balance) / loan.totalLoan) * 100;
                const status = loan.balance <= 0 ? '<span class="badge bg-success">CLEARED</span>' : '<span class="badge bg-primary">ACTIVE</span>';

                tbody.innerHTML += `
                    <tr onclick="openProfile('${loan.id}')">
                        <td><div class="fw-bold text-white">${loan.name}</div><small class="text-muted">${loan.loanDate}</small></td>
                        <td>${status}</td>
                        <td width="30%">
                            <div class="progress" style="height:6px; background:rgba(255,255,255,0.1)">
                                <div class="progress-bar bg-primary" style="width:${percent}%"></div>
                            </div>
                        </td>
                        <td class="text-end fw-bold text-white">₱${loan.balance.toLocaleString()}</td>
                    </tr>
                `;
            });

            document.getElementById('summaryTotalBalance').innerText = '₱' + totalRec.toLocaleString();
            document.getElementById('summaryTotalPaid').innerText = '₱' + totalCol.toLocaleString();
            document.getElementById('summaryTotalInvestment').innerText = '₱' + totalCap.toLocaleString();
            document.getElementById('summaryTotalInterest').innerText = '₱' + totalInt.toLocaleString();

            renderCharts(totalRec, totalCol, totalCap);
        };

        window.openProfile = (id) => {
            currentProfileId = id;
            const loan = loanData.find(l => l.id === id);
            
            // Reset Filters
            document.getElementById('historyFilterType').value = 'all';
            document.getElementById('historyFilterDate').value = '';
            
            updateProfileUI(loan.name, loan.loanDate, loan.balance);
            renderHistory(); // Render with initial filters
            new bootstrap.Modal(document.getElementById('profileModal')).show();
        };

        function updateProfileUI(name, date, balance) {
            document.getElementById('p-name').innerText = name;
            document.getElementById('p-date').innerText = date;
            document.getElementById('p-balance').innerText = '₱' + balance.toLocaleString();
        }

        // --- HISTORY RENDER WITH FILTERS ---
        window.renderHistory = () => {
            if (!currentProfileId) return;
            const loan = loanData.find(l => l.id === currentProfileId);
            const list = document.getElementById('p-history-list');
            list.innerHTML = '';
            
            const filterType = document.getElementById('historyFilterType').value;
            const filterDate = document.getElementById('historyFilterDate').value;

            let history = [...(loan.payments || [])].reverse();

            // Apply Type Filter
            if (filterType !== 'all') {
                history = history.filter(p => p.type === filterType);
            }
            // Apply Date Filter
            if (filterDate) {
                history = history.filter(p => p.date === filterDate);
            }
            
            history.forEach(p => {
                const isPay = p.type === 'payment';
                list.innerHTML += `
                    <div class="d-flex justify-content-between p-3 mb-2 rounded" style="background:rgba(255,255,255,0.03); border-left: 3px solid ${isPay ? '#10b981' : '#ef4444'}">
                        <div>
                            <div class="fw-bold text-white">${isPay ? 'Payment Received' : 'Penalty Added'}</div>
                            <small class="text-muted">${p.date}</small>
                        </div>
                        <div class="fw-bold ${isPay ? 'text-success' : 'text-danger'}">
                            ${isPay ? '+' : '+'}₱${p.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            });

            if (history.length === 0) {
                list.innerHTML = '<p class="text-muted text-center mt-4">No history found.</p>';
            }
        }

        window.filterTable = () => {
            const term = document.getElementById('filterUtang').value.toLowerCase();
            const rows = document.querySelectorAll('#utangListBody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function renderCharts(bal, col, cap) {
            const ctx1 = document.getElementById('financeChart');
            if(chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Balance', 'Collected', 'Capital'],
                    datasets: [{ label: 'Amount', data: [bal, col, cap], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'] }]
                },
                options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{color:'rgba(255,255,255,0.05)'}}} }
            });

            const ctx2 = document.getElementById('statusChart');
            if(chart2) chart2.destroy();
            chart2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Collected'],
                    datasets: [{ data: [bal, col], backgroundColor: ['#3b82f6', '#10b981'], borderWidth:0 }]
                },
                options: { cutout: '70%', plugins:{legend:{position:'bottom'}} }
            });
        }

        // --- PDF DOWNLOADER SCRIPT ---
        window.downloadPDF = () => {
            if (!window.jspdf) {
                alert("Library not loaded!");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Helper
            const formatNumber = (num) => num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            // --- 1. HEADER ---
            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text('LendingMaster Report', 14, 20);
            
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 26);
            
            // --- 2. SUMMARY TABLE (Top Box) ---
            let totalInvestment = 0;
            let totalBalance = 0;
            let totalPaid = 0;

            loanData.forEach(loan => {
                totalInvestment += loan.initialLoan;
                totalBalance += loan.balance;
                const paid = (loan.payments || []).filter(p => p.type === 'payment').reduce((a,b) => a + b.amount, 0);
                totalPaid += paid;
            });

            doc.autoTable({
                startY: 35,
                head: [['Total Investment', 'Total Collected', 'Outstanding Balance']],
                body: [[formatNumber(totalInvestment), formatNumber(totalPaid), formatNumber(totalBalance)]],
                theme: 'grid',
                headStyles: { fillColor: [37, 99, 235] }, // Blue Header
                styles: { halign: 'center' }
            });

            // --- 3. BORROWER LIST (Main Table) ---
            const rows = loanData.map(u => [
                u.name,
                u.loanDate,
                formatNumber(u.totalLoan),
                formatNumber(u.totalLoan - u.balance), 
                formatNumber(u.balance)
            ]);

            doc.text('Borrower Status', 14, doc.lastAutoTable.finalY + 15);
            
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 20,
                head: [['Name', 'Date', 'Total Loan', 'Paid', 'Balance']],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [30, 41, 59] } // Dark Slate Header
            });

            // --- 4. PAYMENTS TODAY (Optional Page) ---
            const today = new Date().toISOString().split('T')[0];
            
            // Collect all payments from all users
            let todayPayments = [];
            loanData.forEach(loan => {
                const userPays = (loan.payments || []).filter(p => p.date === today && p.type === 'payment');
                userPays.forEach(pay => {
                    todayPayments.push({name: loan.name, amount: pay.amount});
                });
            });
            
            if(todayPayments.length > 0) {
                doc.addPage();
                doc.text(`Payments Collected Today (${today})`, 14, 20);
                
                const payRows = todayPayments.map(p => [p.name, formatNumber(p.amount)]);
                const totalToday = todayPayments.reduce((s,p) => s + p.amount, 0);
                payRows.push(['TOTAL', formatNumber(totalToday)]);

                doc.autoTable({
                    startY: 30,
                    head: [['Payer Name', 'Amount']],
                    body: payRows,
                    theme: 'grid',
                    headStyles: { fillColor: [16, 185, 129] } // Green Header
                });
            }

            // --- SAVE FILE ---
            doc.save("LendingMaster_Report.pdf");
        }
    </script>
</body>
</html>
