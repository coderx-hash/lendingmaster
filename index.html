<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>LendingMaster Pro | Financial Suite v9.0 (UI Fixes)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-dark: #0f111a;          
            --bg-panel: #161b2c;        
            --bg-input: #1f2940;
            
            --primary: #3b82f6;          
            --primary-vibrant: #2563eb;
            --text-main: #ffffff;       
            --text-muted: #94a3b8;      
            
            --success: #10b981;
            --danger: #ef4444; 
            --warning: #f59e0b;
            --info: #06b6d4;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
            overscroll-behavior-y: none;
        }

        /* --- BACKGROUND ANIMATION --- */
        .animated-bg {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1;
            background: var(--bg-dark);
            overflow: hidden;
        }
        .blob {
            position: absolute; 
            border-radius: 50%; 
            filter: blur(80px); 
            opacity: 0.6;
            animation: float 10s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: rgba(59, 130, 246, 0.25); }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: rgba(16, 185, 129, 0.15); animation-delay: -5s; }
        
        @keyframes float { 
            0% { transform: translate(0, 0) scale(1); } 
            100% { transform: translate(20px, 40px) scale(1.1); } 
        }

        /* --- GLASS PANELS --- */
        .glass-panel {
            background: rgba(22, 27, 44, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        /* --- NOTIFICATION ANIMATIONS & STYLES --- */
        .hover-opacity-100:hover { opacity: 1 !important; }
        .transition { transition: all 0.3s ease; }

        @keyframes bellShake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            100% { transform: rotate(0); }
        }

        .bell-ringing {
            animation: bellShake 2s infinite;
            color: var(--warning) !important;
        }

        .unpaid-row {
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .unpaid-row:hover {
            background-color: rgba(59, 130, 246, 0.15);
            padding-left: 10px !important;
            cursor: pointer;
        }
        .unpaid-row:last-child { border-bottom: none; }

        /* --- SCROLLBAR STYLING --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-vibrant); }

        /* --- LOGIN PAGE STYLING --- */
        .login-card {
            width: 100%; 
            max-width: 420px; 
            padding: 45px 35px; 
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.15);
        }
        .login-card h2 { color: #ffffff !important; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .login-card p.small { color: rgba(255,255,255,0.9) !important; font-weight: 500; }
        .login-card label { color: #ffffff !important; font-size: 0.85rem; font-weight: 700; letter-spacing: 1px; }
        
        .login-input {
            background: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
            border-radius: 12px !important;
            padding: 14px 18px !important;
            font-size: 1rem !important;
            transition: 0.3s all;
        }
        .login-input:focus {
            background: rgba(0, 0, 0, 0.6) !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.25) !important;
        }
        .login-input::placeholder { color: rgba(255,255,255,0.5) !important; }
        .glow-icon { filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.8)); }

        /* --- WHITE MODE (Register Only) --- */
        .glass-panel.white-mode {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15) !important;
        }
        .glass-panel.white-mode h2, 
        .glass-panel.white-mode h5, 
        .glass-panel.white-mode p, 
        .glass-panel.white-mode label, 
        .glass-panel.white-mode .step-title { color: #1e293b !important; text-shadow: none !important; }
        .glass-panel.white-mode .text-muted { color: #64748b !important; }
        .glass-panel.white-mode input.form-control { 
            background-color: #f1f5f9 !important; 
            border: 1px solid #cbd5e1 !important; 
            color: #0f172a !important; 
            box-shadow: none !important; 
        }
        .glass-panel.white-mode input.form-control:focus { 
            background-color: #ffffff !important; 
            border-color: var(--primary) !important; 
        }

        /* --- DASHBOARD ELEMENTS --- */
        .stat-card {
            background: var(--bg-panel); 
            border-radius: 12px; 
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05); 
            transition: transform 0.2s; 
            position: relative; 
            overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(59, 130, 246, 0.3); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        
        .border-blue::before { background: var(--primary); }
        .border-green::before { background: var(--success); }
        .border-yellow::before { background: var(--warning); }
        .border-red::before { background: var(--danger); }
        .border-info::before { background: var(--info); }

        .stat-value { font-size: 1.6rem; font-weight: 800; letter-spacing: -0.5px; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 600; color: var(--text-muted); letter-spacing: 0.5px; }

        /* --- INPUTS GENERAL - UPDATED FOR WHITE TEXT --- */
        .form-control, .form-select {
            background-color: var(--bg-input); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: #ffffff !important; /* Force White Text */
            padding: 10px 15px; 
            border-radius: 8px; 
            font-size: 0.9rem;
        }
        .form-control:focus, .form-select:focus {
            background-color: #263350; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); 
            color: #ffffff !important;
        }
        /* Make placeholders visible */
        ::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
            opacity: 1;
        }
        
        input[type="date"], input[type="month"] { color-scheme: dark; }

        /* --- BUTTONS --- */
        .btn-primary-pro {
            background: linear-gradient(135deg, var(--primary), var(--primary-vibrant));
            color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: all 0.3s;
        }
        .btn-primary-pro:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5); }
        
        .btn-white-pro {
            background: #ffffff; color: #0f111a; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 800;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.15); transition: all 0.3s;
        }
        .btn-white-pro:hover { background: #f0f0f0; color: black; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 255, 255, 0.4); }

        .btn-delete-animate {
            background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger);
            width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; transition: 0.3s;
        }
        .btn-delete-animate:hover { background: var(--danger); color: white; box-shadow: 0 0 15px var(--danger); cursor: pointer; }

        .btn-icon-del {
            background: transparent; border: none; color: #ef4444; opacity: 0.6; transition: 0.2s;
        }
        .btn-icon-del:hover { opacity: 1; transform: scale(1.1); color: #ff0000; }

        /* --- LAYOUTS --- */
        #auth-section {
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 100%; 
            padding: 20px; 
            position: relative; 
            z-index: 10;
        }
        .step-indicator { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .step-title { color: white; font-weight: 700; margin-bottom: 15px; }

        .custom-table th { background: #111521; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }
        .custom-table td { background: var(--bg-panel); padding: 15px; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .custom-table tr:hover td { background: #1c233a; cursor: pointer; }

        #demo-timer-bar {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); border: 1px solid var(--danger);
            color: var(--danger); padding: 10px 20px; border-radius: 50px; font-family: 'Courier New', monospace; font-weight: 700;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); z-index: 2000; display: none; align-items: center; gap: 10px;
        }
        .timer-icon { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- MODALS --- */
        .modal-content { background-color: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1); }
        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .btn-close { filter: invert(1); }
        
        .history-filter-select {
            background-color: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted);
            font-size: 0.85rem; padding: 8px 12px; border-radius: 6px;
        }
        .history-date { color: rgba(255, 255, 255, 0.6) !important; font-size: 0.75rem; }
        .hidden { display: none !important; }

        .filter-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; display: block; }
        .collection-breakdown-row .stat-card {
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            padding: 15px;
        }

        @media (max-width: 768px) {
            .stat-value { font-size: 1.4rem; }
            .modal-dialog { margin: 10px; }
            .col-md-5, .col-md-7 { width: 100%; }
            .history-filter-select { font-size: 0.75rem; padding: 6px; }
            #auth-section { align-items: flex-start; padding-top: 10vh; }
        }
    </style>
</head>
<body>

    <div class="animated-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div id="demo-timer-bar">
        <i class="fas fa-clock timer-icon"></i>
        <span>DEMO ENDS IN: <span id="timer-countdown">01:00</span></span>
    </div>

    <section id="auth-section">
        <div class="glass-panel login-card" id="main-auth-card">
            <div class="mb-4">
                <i class="fas fa-hand-holding-dollar fa-3x text-primary glow-icon"></i>
            </div>
            <h2 class="fw-bold mb-1">LendingMaster</h2>
            <p class="small mb-4">Financial Management Suite v9.0</p>

            <div id="login-form">
                <div class="text-start mb-4">
                    <label class="mb-2 ms-1">ACCOUNT ACCESS</label>
                    <input type="email" id="email" class="form-control login-input mb-3" placeholder="Email Address">
                    <input type="password" id="password" class="form-control login-input" placeholder="Password">
                </div>
                <button class="btn-primary-pro w-100 mb-3" onclick="handleLogin()">SECURE LOGIN</button>
                <div class="d-flex flex-column gap-2">
                    <button class="btn-white-pro w-100" onclick="showRegStep(1)">
                        <i class="fas fa-user-plus me-2"></i> Create Account
                    </button>
                    <button class="btn btn-link text-white text-decoration-none btn-sm fw-bold" onclick="startDemo()">
                        <i class="fas fa-rocket me-1"></i> Try Demo (1 Min)
                    </button>
                </div>
            </div>

            <div id="reg-container" class="hidden text-start">
                
                <div id="reg-step-1">
                    <div class="step-indicator text-primary">Step 1 of 3: Payment</div>
                    <h5 class="step-title">Subscription Payment</h5>
                    <div class="p-3 rounded mb-3" style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3);">
                        <p class="mb-1 small text-muted">Send payment via GCash:</p>
                        <h4 class="fw-bold mb-0" style="color: #3b82f6;">0948-374-8304</h4>
                        <small class="text-muted">Name: AN......LO</small>
                    </div>
                    <button class="btn-primary-pro w-100" onclick="showRegStep(2)">I have sent payment <i class="fas fa-arrow-right ms-2"></i></button>
                    <button class="btn btn-link text-muted w-100 mt-2 text-decoration-none" onclick="showRegStep(0)">Cancel</button>
                </div>

                <div id="reg-step-2" class="hidden">
                    <div class="step-indicator text-warning">Step 2 of 3: Verification</div>
                    <h5 class="step-title">Payment Details</h5>
                    <div class="mb-3">
                        <input type="text" id="reg-ref" class="form-control mb-2" placeholder="GCash Reference No.">
                        <input type="text" id="reg-sender" class="form-control mb-2" placeholder="Sender Name">
                        <input type="text" id="reg-mobile" class="form-control" placeholder="Sender Mobile No.">
                    </div>
                    <button class="btn-primary-pro w-100" onclick="showRegStep(3)">Next Step <i class="fas fa-arrow-right ms-2"></i></button>
                    <button class="btn btn-link text-muted w-100 mt-2 text-decoration-none" onclick="showRegStep(1)">Back</button>
                </div>

                <div id="reg-step-3" class="hidden">
                    <div class="step-indicator text-success">Step 3 of 3: Account</div>
                    <h5 class="step-title">Create Login</h5>
                    <div class="mb-3">
                        <input type="email" id="reg-email" class="form-control mb-2" placeholder="Email Address">
                        <input type="password" id="reg-password" class="form-control" placeholder="Create Password">
                    </div>
                    <button class="btn-primary-pro w-100" onclick="handleSignup()">Submit for Activation</button>
                    <button class="btn btn-link text-muted w-100 mt-2 text-decoration-none" onclick="showRegStep(2)">Back</button>
                </div>

            </div>
        </div>
    </section>

    <section id="dashboard-section" style="display: none;">
        
        <nav class="navbar navbar-expand-lg py-3 mb-4" style="background: rgba(22, 27, 44, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05);">
            <div class="container-fluid px-4">
                <a class="navbar-brand fw-bold text-white d-flex align-items-center" href="#">
                    <i class="fas fa-chart-pie text-primary me-2"></i> LendingMaster <span class="badge bg-danger ms-2" style="font-size: 0.6rem;">PRO</span>
                </a>
                
                <div class="d-flex align-items-center gap-3">
                    <div class="position-relative" style="cursor: pointer;" onclick="showUnpaidNotif()">
                        <i class="fas fa-bell fa-lg text-white opacity-75 hover-opacity-100 transition"></i>
                        <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">
                            0
                        </span>
                    </div>

                    <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container-fluid px-4 pb-5">
            
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card border-blue">
                        <div class="stat-label">Total Receivables</div>
                        <div class="stat-value text-primary" id="summaryTotalBalance">₱0</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-green">
                        <div class="stat-label">Overall Collected</div>
                        <div class="stat-value text-success" id="summaryTotalPaid">₱0</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-yellow">
                        <div class="stat-label">Capital Out</div>
                        <div class="stat-value text-warning" id="summaryTotalInvestment">₱0</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-red">
                        <div class="stat-label">Proj. Interest</div>
                        <div class="stat-value text-danger" id="summaryTotalInterest">₱0</div>
                    </div>
                </div>
            </div>

            <h6 class="text-white fw-bold mb-3 ms-1">Collection Performance</h6>
            <div class="row g-3 mb-4 collection-breakdown-row">
                
                <div class="col-md-4 col-12">
                    <label class="filter-label">Filter Daily</label>
                    <input type="date" id="filterDayInput" class="form-control mb-2 text-center" onchange="renderCollectionStats()">
                    <div class="stat-card border-info">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="stat-label text-info">Daily Total</div>
                                <div class="stat-value text-white" id="colDaily">₱0</div>
                            </div>
                            <i class="fas fa-calendar-day fa-2x text-info opacity-25"></i>
                        </div>
                        <div class="d-flex justify-content-between border-top border-white border-opacity-10 pt-2 mt-1">
                            <div class="text-start">
                                <small class="text-muted" style="font-size:0.65rem;">CASH</small>
                                <div class="fw-bold text-success" style="font-size:0.9rem;" id="colDailyCash">₱0</div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted" style="font-size:0.65rem;">ONLINE</small>
                                <div class="fw-bold text-primary" style="font-size:0.9rem;" id="colDailyOnline">₱0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-6">
                    <label class="filter-label">Filter Monthly</label>
                    <input type="month" id="filterMonthInput" class="form-control mb-2 text-center" onchange="renderCollectionStats()">
                    <div class="stat-card border-info">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="stat-label text-info">Monthly Total</div>
                                <div class="stat-value text-white" id="colMonthly">₱0</div>
                            </div>
                            <i class="fas fa-calendar-alt fa-2x text-info opacity-25"></i>
                        </div>
                        <div class="d-flex justify-content-between border-top border-white border-opacity-10 pt-2 mt-1">
                            <div class="text-start">
                                <small class="text-muted" style="font-size:0.65rem;">CASH</small>
                                <div class="fw-bold text-success" style="font-size:0.9rem;" id="colMonthlyCash">₱0</div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted" style="font-size:0.65rem;">ONLINE</small>
                                <div class="fw-bold text-primary" style="font-size:0.9rem;" id="colMonthlyOnline">₱0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-6">
                    <label class="filter-label">Filter Yearly</label>
                    <input type="number" id="filterYearInput" class="form-control mb-2 text-center" placeholder="YYYY" min="2020" max="2030" onchange="renderCollectionStats()">
                    <div class="stat-card border-info">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="stat-label text-info">Yearly Total</div>
                                <div class="stat-value text-white" id="colYearly">₱0</div>
                            </div>
                            <i class="fas fa-chart-line fa-2x text-info opacity-25"></i>
                        </div>
                        <div class="d-flex justify-content-between border-top border-white border-opacity-10 pt-2 mt-1">
                            <div class="text-start">
                                <small class="text-muted" style="font-size:0.65rem;">CASH</small>
                                <div class="fw-bold text-success" style="font-size:0.9rem;" id="colYearlyCash">₱0</div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted" style="font-size:0.65rem;">ONLINE</small>
                                <div class="fw-bold text-primary" style="font-size:0.9rem;" id="colYearlyOnline">₱0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-3 mb-4 d-flex flex-wrap gap-3 align-items-center justify-content-between">
                <div class="flex-grow-1" style="max-width: 400px;">
                    <input type="text" id="filterUtang" class="form-control" placeholder="Search borrower..." onkeyup="filterTable()">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary text-white" onclick="downloadPDF()"><i class="fas fa-print me-2"></i> Report</button>
                    <button class="btn-primary-pro" data-bs-toggle="modal" data-bs-target="#addLoanModal"><i class="fas fa-plus me-2"></i> New Contract</button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-xl-8">
                    <div class="glass-panel h-100 p-0 overflow-hidden">
                        <div class="p-3 border-bottom border-white border-opacity-10 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-white">Active Contracts (A-Z)</h6>
                            <span class="badge bg-success bg-opacity-10 text-success">Sorted</span>
                        </div>
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table custom-table mb-0" id="utangListTable">
                                <thead>
                                    <tr>
                                        <th>Borrower Details</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th class="text-end">Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="utangListBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4">
                    <div class="glass-panel p-4 mb-4">
                        <h6 class="stat-label mb-3">Cash Flow</h6>
                        <div style="height: 200px;"><canvas id="financeChart"></canvas></div>
                    </div>
                    <div class="glass-panel p-4">
                        <h6 class="stat-label mb-3">Portfolio Health</h6>
                        <div style="height: 200px;"><canvas id="statusChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="addLoanModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">New Contract</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="utangForm">
                        <label class="stat-label mb-1">Borrower Name</label>
                        <input type="text" id="name" class="form-control mb-3" placeholder="Full Name">
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="stat-label mb-1">Principal</label>
                                <input type="text" id="initialLoan" class="form-control" placeholder="0" oninput="formatInputCurrency(this)">
                            </div>
                            <div class="col-6">
                                <label class="stat-label mb-1">Interest</label>
                                <select id="interestRate" class="form-select">
                                    <option value="0.0">0%</option>
                                    <option value="0.10">10%</option>
                                    <option value="0.20" selected>20%</option>
                                    <option value="0.30">30%</option>
                                    <option value="0.40">40%</option>
                                    <option value="0.50">50%</option>
                                </select>
                            </div>
                        </div>
                        <label class="stat-label mb-1">Date</label>
                        <input type="date" id="loanDate" class="form-control">
                    </form>
                </div>
                <div class="modal-footer p-3">
                    <button type="button" class="btn-primary-pro w-100" onclick="addUtang()">Save Contract</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content overflow-hidden">
                <div class="modal-header p-4">
                    <div>
                        <h4 id="p-name" class="mb-0 fw-bold text-white">Name</h4>
                        <small id="p-date" class="text-white opacity-75">Date</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <div class="col-md-5 p-4 bg-dark border-end border-white border-opacity-10">
                            <div class="text-center mb-4 p-3 rounded" style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3);">
                                <small class="text-primary fw-bold text-uppercase">Balance</small>
                                <h2 id="p-balance" class="text-white fw-bold m-0">₱0</h2>
                            </div>

                            <label class="stat-label text-success mb-2">Add Payment</label>
                            <select id="p-payment-method" class="form-select mb-2" style="font-size: 0.85rem; border-color: rgba(16, 185, 129, 0.5); color: #10b981;">
                                <option value="cash" selected>Cash Payment</option>
                                <option value="online">GCash / Online</option>
                            </select>

                            <div class="d-flex gap-2 mb-2">
                                <input type="text" id="p-pay-amount" class="form-control" placeholder="Amount" oninput="formatInputCurrency(this)">
                                <input type="date" id="p-pay-date" class="form-control" style="width: 140px;"> 
                            </div>
                            <button class="btn-primary-pro w-100 mb-4" style="background: var(--success);" onclick="executePayment()">Submit Payment</button>

                            <hr class="border-white opacity-10">

                            <label class="stat-label text-danger mb-2">Penalty</label>
                            <div class="input-group mb-4">
                                <input type="text" id="p-penalty-amount" class="form-control" placeholder="Fee" oninput="formatInputCurrency(this)">
                                <button class="btn btn-outline-danger" onclick="executePenalty()">Apply</button>
                            </div>

                            <button class="btn-delete-animate" onclick="deleteCurrentProfile()">
                                <i class="fas fa-trash-alt me-2"></i> DELETE RECORD
                            </button>
                        </div>

                        <div class="col-md-7 p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="stat-label mb-0">Transaction History</h6>
                                <div class="d-flex gap-2">
                                    <select id="historyFilterType" class="history-filter-select" onchange="renderHistory()">
                                        <option value="all">All Types</option>
                                        <option value="payment">Payments</option>
                                        <option value="penalty">Penalties</option>
                                    </select>
                                    <input type="date" id="historyFilterDate" class="history-filter-select" style="width: 130px;" onchange="renderHistory()">
                                </div>
                            </div>
                            <div style="height: 350px; overflow-y: auto;" id="p-history-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB3lUsTef1DdBhaUfmw0vkYv72MMpPlvBI",
            authDomain: "lendingmaster-e2a58.firebaseapp.com",
            projectId: "lendingmaster-e2a58",
            storageBucket: "lendingmaster-e2a58.firebasestorage.app",
            messagingSenderId: "737470799590",
            appId: "1:737470799590:web:0bb175b1a6e49f54326527",
            measurementId: "G-04X6MKXGW3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let unsubscribeLoans = null;
        let loanData = [];
        let currentProfileId = null;
        let chart1, chart2;

        // --- HELPER FUNCTIONS ---
        window.formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // --- AUTO-COMMA FUNCTIONS ---
        window.formatInputCurrency = (input) => {
            let value = input.value.replace(/,/g, '');
            if(value && !isNaN(value)) {
                if(value.endsWith('.')) return; 
                const parts = value.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                input.value = parts.join('.');
            } else {
                if (value === '') input.value = '';
            }
        };

        const parseVal = (id) => {
            const raw = document.getElementById(id).value.replace(/,/g, '');
            return parseFloat(raw) || 0;
        };

        // --- DEMO MODE LOGIC ---
        window.startDemo = () => {
            const blocked = localStorage.getItem('demoBlocked');
            if (blocked) {
                Swal.fire({icon:'error', title:'Demo Expired', text:'Please subscribe to access.', background:'#161b2c', color:'white'});
                return;
            }

            const demoDuration = 60000; // 1 Minute
            localStorage.setItem('demoStart', Date.now());
            
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('demo-timer-bar').style.display = 'flex';
            
            // Initial Mock Data for Demo
            loanData = [
                {id: 'demo1', name: 'Alma', balance: 500, initialLoan: 500, interest: 100, totalLoan: 600, loanDate: '2025-12-10', payments: []},
                {id: 'demo2', name: 'Amy', balance: 14750, initialLoan: 15000, interest: 3000, totalLoan: 18000, loanDate: '2025-12-11', payments: []},
                {id: 'demo3', name: 'Ana', balance: 6000, initialLoan: 6000, interest: 1200, totalLoan: 7200, loanDate: '2025-12-11', payments: []},
                {id: 'demo4', name: 'Juan', balance: 0, initialLoan: 2000, interest: 400, totalLoan: 2400, loanDate: '2025-11-20', payments: [{amount:2400, type:'payment'}]},
            ];
            // Add dummy data to show scrolling
            for(let i=1; i<=5; i++) {
                loanData.push({id: `dummy${i}`, name: `Borrower ${i}`, balance: 1000, initialLoan: 1000, interest: 200, totalLoan: 1200, loanDate: '2025-12-12', payments: []});
            }

            initializeFilters();
            renderAll();

            const timerInterval = setInterval(() => {
                const now = Date.now();
                const start = parseInt(localStorage.getItem('demoStart'));
                const elapsed = now - start;
                const remaining = demoDuration - elapsed;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    localStorage.setItem('demoBlocked', 'true');
                    document.body.innerHTML = "<div style='height:100vh; display:flex; justify-content:center; align-items:center; background:#0f111a; color:white; flex-direction:column;'><h1>DEMO EXPIRED</h1><p>Please contact admin to subscribe.</p></div>";
                } else {
                    const seconds = Math.floor(remaining / 1000);
                    document.getElementById('timer-countdown').innerText = `00:${seconds < 10 ? '0'+seconds : seconds}`;
                }
            }, 1000);
        };

        // --- AUTH UI HANDLERS ---
        window.showRegStep = (step) => {
            const card = document.getElementById('main-auth-card');
            
            if(step === 0) {
                // Back to Login
                document.getElementById('reg-container').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
                card.classList.remove('white-mode');
            } else {
                // Go to Register
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('reg-container').classList.remove('hidden');
                card.classList.add('white-mode');
                
                // Hide all steps first
                [1, 2, 3].forEach(i => document.getElementById(`reg-step-${i}`).classList.add('hidden'));
                // Show requested step
                document.getElementById(`reg-step-${step}`).classList.remove('hidden');
            }
        };

        window.handleSignup = async () => {
            const ref = document.getElementById('reg-ref').value;
            const sender = document.getElementById('reg-sender').value;
            const mobile = document.getElementById('reg-mobile').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            if(!ref || !sender || !mobile || !email || !password) {
                Swal.fire({icon:'warning', title:'Missing Details', text:'Fill all fields.', background:'#161b2c', color:'white'});
                return;
            }

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), {
                    email: email, gcashReference: ref, senderName: sender, senderMobile: mobile, status: 'pending', createdAt: new Date()
                });
                Swal.fire({icon:'success', title:'Registered!', text:'Wait for Admin approval.', background:'#161b2c', color:'white'});
                showRegStep(0);
            } catch (error) {
                Swal.fire({icon:'error', title:'Error', text: error.message, background:'#161b2c', color:'white'});
            }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const cred = await signInWithEmailAndPassword(auth, email, password);
                checkUserStatus(cred.user.uid);
            } catch (error) {
                Swal.fire({icon:'error', title:'Login Failed', text:'Check credentials.', background:'#161b2c', color:'white'});
            }
        };

        async function checkUserStatus(uid) {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                if (data.status === 'active') {
                    currentUser = uid;
                    initDashboard();
                } else {
                    await signOut(auth);
                    Swal.fire({icon:'info', title:'Pending Activation', text:'Admin has not activated this account yet.', background:'#161b2c', color:'white'});
                }
            } else {
                currentUser = uid;
                initDashboard();
            }
        }

        window.handleLogout = async () => {
            if(unsubscribeLoans) unsubscribeLoans();
            await signOut(auth);
            location.reload();
        };

        function initDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            
            // Set default filters to today
            initializeFilters();

            const loansRef = collection(db, `users/${currentUser}/loans`);
            unsubscribeLoans = onSnapshot(loansRef, (snapshot) => {
                loanData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
                
                if (currentProfileId) {
                    const loan = loanData.find(l => l.id === currentProfileId);
                    if(loan) {
                        updateProfileUI(loan.name, loan.loanDate, loan.balance);
                        renderHistory();
                    }
                }
            });
        }

        // --- FILTER INITIALIZATION ---
        function initializeFilters() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');

            document.getElementById('filterDayInput').value = `${year}-${month}-${day}`;
            document.getElementById('filterMonthInput').value = `${year}-${month}`;
            document.getElementById('filterYearInput').value = year;
        }

        // --- LOAN CRUD FUNCTIONS ---
        window.addUtang = async () => {
            const name = document.getElementById('name').value.trim();
            const principal = parseVal('initialLoan');
            const rate = parseFloat(document.getElementById('interestRate').value);
            const date = document.getElementById('loanDate').value;

            if(!name || !principal || !date) return;

            // --- ANTI-OVERRIDE / AUTO-NUMBERING LOGIC ---
            let finalName = name;
            let counter = 2;
            
            while(loanData.some(l => l.name.toLowerCase() === finalName.toLowerCase())) {
                finalName = `${name} (${counter})`;
                counter++;
            }

            const interest = principal * rate;
            const total = principal + interest;

            if(currentUser) {
                await setDoc(doc(collection(db, `users/${currentUser}/loans`)), {
                    name: finalName, 
                    initialLoan: principal, 
                    interest, 
                    totalLoan: total, 
                    balance: total, 
                    loanDate: date, 
                    payments: []
                });
            } else {
                loanData.push({ id: Date.now(), name: finalName, initialLoan: principal, interest, totalLoan: total, balance: total, loanDate: date, payments: [] });
                renderAll();
            }

            bootstrap.Modal.getInstance(document.getElementById('addLoanModal')).hide();
            document.getElementById('utangForm').reset();
            Swal.fire({
                icon:'success', 
                title:`Contract Saved: ${finalName}`, 
                toast:true, position:'top-end', showConfirmButton:false, timer:2500, background:'#161b2c', color:'white'
            });
        };

        // --- PAYMENT FUNCTION (WITH METHOD) ---
        window.executePayment = async () => {
            const amount = parseVal('p-pay-amount');
            const date = document.getElementById('p-pay-date').value;
            const method = document.getElementById('p-payment-method').value;

            if(!amount || !date) {
                 Swal.fire({icon:'warning', title:'Required', text:'Please enter amount and date', background:'#161b2c', color:'white'});
                 return;
            }

            const loan = loanData.find(l => l.id === currentProfileId);
            const newBalance = loan.balance - amount;
            
            const newPayment = { amount, date, type: 'payment', method: method };
            const updatedPayments = [...(loan.payments || []), newPayment];

            if(currentUser) {
                await updateDoc(doc(db, `users/${currentUser}/loans`, currentProfileId), {
                    balance: newBalance,
                    payments: updatedPayments
                });
            } else {
                loan.balance = newBalance;
                loan.payments = updatedPayments;
                updateProfileUI(loan.name, loan.loanDate, newBalance);
                renderHistory();
                renderAll();
            }
            document.getElementById('p-pay-amount').value = '';
        };

        window.executePenalty = async () => {
            const amount = parseVal('p-penalty-amount');
            if(!amount) return;

            const loan = loanData.find(l => l.id === currentProfileId);
            const newBalance = loan.balance + amount;
            const newTotal = loan.totalLoan + amount;
            const today = new Date().toISOString().split('T')[0];
            const newPenalty = { amount, date: today, type: 'penalty' };
            const updatedPayments = [...(loan.payments || []), newPenalty];

            if(currentUser) {
                await updateDoc(doc(db, `users/${currentUser}/loans`, currentProfileId), {
                    balance: newBalance,
                    totalLoan: newTotal,
                    payments: updatedPayments
                });
            } else {
                loan.balance = newBalance;
                loan.totalLoan = newTotal;
                loan.payments = updatedPayments;
                updateProfileUI(loan.name, loan.loanDate, newBalance);
                renderHistory();
                renderAll();
            }
            document.getElementById('p-penalty-amount').value = '';
        };

        // --- DELETE TRANSACTION LOGIC ---
        window.deleteTransaction = async (originalIndex) => {
            const confirm = await Swal.fire({
                title: 'Delete Transaction?',
                text: "This will revert the balance adjustment.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                background: '#161b2c',
                color: 'white'
            });

            if (!confirm.isConfirmed) return;

            const loan = loanData.find(l => l.id === currentProfileId);
            const transaction = loan.payments[originalIndex];
            
            let newBalance = loan.balance;
            let newTotalLoan = loan.totalLoan;

            if (transaction.type === 'payment') {
                newBalance += transaction.amount; 
            } else if (transaction.type === 'penalty') {
                newBalance -= transaction.amount; 
                newTotalLoan -= transaction.amount; 
            }

            const updatedPayments = [...loan.payments];
            updatedPayments.splice(originalIndex, 1);

            if (currentUser) {
                await updateDoc(doc(db, `users/${currentUser}/loans`, currentProfileId), {
                    balance: newBalance,
                    totalLoan: newTotalLoan,
                    payments: updatedPayments
                });
            } else {
                loan.balance = newBalance;
                loan.totalLoan = newTotalLoan;
                loan.payments = updatedPayments;
                updateProfileUI(loan.name, loan.loanDate, newBalance);
                renderHistory();
                renderAll();
            }
            
            Swal.fire({
                icon:'success', 
                title:'Deleted', 
                toast:true, position:'top-end', showConfirmButton:false, timer:1500, background:'#161b2c', color:'white'
            });
        };

        window.deleteCurrentProfile = async () => {
            const result = await Swal.fire({
                title: 'Delete Record?', text: "Permanent Action.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', background:'#161b2c', color:'white'
            });

            if(result.isConfirmed) {
                if(currentUser) {
                    await deleteDoc(doc(db, `users/${currentUser}/loans`, currentProfileId));
                } else {
                    loanData = loanData.filter(l => l.id !== currentProfileId);
                    renderAll();
                }
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            }
        };

        // --- STATS RENDERING WITH CASH/ONLINE BREAKDOWN ---
        window.renderCollectionStats = () => {
            const filterDay = document.getElementById('filterDayInput').value;
            const filterMonth = document.getElementById('filterMonthInput').value;
            const filterYear = document.getElementById('filterYearInput').value;

            let dTotal = 0, dCash = 0, dOnline = 0;
            let mTotal = 0, mCash = 0, mOnline = 0;
            let yTotal = 0, yCash = 0, yOnline = 0;

            loanData.forEach(loan => {
                const payments = loan.payments || [];
                payments.forEach(p => {
                    if(p.type === 'payment' && p.date) {
                        const amt = p.amount;
                        const isOnline = p.method === 'online'; 

                        if(p.date === filterDay) {
                            dTotal += amt;
                            if(isOnline) dOnline += amt; else dCash += amt;
                        }
                        if(p.date.startsWith(filterMonth)) {
                            mTotal += amt;
                            if(isOnline) mOnline += amt; else mCash += amt;
                        }
                        if(p.date.startsWith(filterYear)) {
                            yTotal += amt;
                            if(isOnline) yOnline += amt; else yCash += amt;
                        }
                    }
                });
            });

            document.getElementById('colDaily').innerText = '₱' + dTotal.toLocaleString();
            document.getElementById('colDailyCash').innerText = '₱' + dCash.toLocaleString();
            document.getElementById('colDailyOnline').innerText = '₱' + dOnline.toLocaleString();

            document.getElementById('colMonthly').innerText = '₱' + mTotal.toLocaleString();
            document.getElementById('colMonthlyCash').innerText = '₱' + mCash.toLocaleString();
            document.getElementById('colMonthlyOnline').innerText = '₱' + mOnline.toLocaleString();

            document.getElementById('colYearly').innerText = '₱' + yTotal.toLocaleString();
            document.getElementById('colYearlyCash').innerText = '₱' + yCash.toLocaleString();
            document.getElementById('colYearlyOnline').innerText = '₱' + yOnline.toLocaleString();
        };

        // --- UPDATED RENDER ALL FUNCTION ---
        window.renderAll = () => {
            const tbody = document.getElementById('utangListBody');
            let rowsHtml = '';
            let totalRec = 0, totalCol = 0, totalCap = 0, totalInt = 0;

            loanData.sort((a, b) => a.name.localeCompare(b.name));

            loanData.forEach(loan => {
                totalRec += loan.balance;
                totalCap += loan.initialLoan;
                totalInt += loan.interest;
                totalCol += (loan.payments || []).filter(p => p.type === 'payment').reduce((a,b) => a + b.amount, 0);

                const percent = ((loan.totalLoan - loan.balance) / loan.totalLoan) * 100;
                // Determine Status Badge
                const isCleared = loan.balance <= 0;
                const statusBadge = isCleared ? '<span class="badge bg-success">CLEARED</span>' : '<span class="badge bg-primary">ACTIVE</span>';
                
                // Date Color (Green if Active, Red if Cleared/Zero Balance)
                const dateColorClass = isCleared ? 'text-danger' : 'text-success';

                rowsHtml += `
                    <tr onclick="openProfile('${loan.id}')">
                        <td>
                            <div class="fw-bold text-white mb-1" style="font-size: 1rem;">${loan.name}</div>
                            <div class="d-flex gap-2 mb-1">
                                <span class="badge bg-secondary bg-opacity-25 text-info border border-info border-opacity-25" style="font-size: 0.7rem; font-weight:500;">
                                    P: ₱${loan.initialLoan.toLocaleString()}
                                </span>
                                <span class="badge bg-secondary bg-opacity-25 text-warning border border-warning border-opacity-25" style="font-size: 0.7rem; font-weight:500;">
                                    I: ₱${loan.interest.toLocaleString()}
                                </span>
                            </div>
                            <small class="${dateColorClass} fw-bold" style="font-size: 0.75rem;">
                                ${window.formatDate(loan.loanDate)}
                            </small>
                        </td>
                        <td>${statusBadge}</td>
                        <td width="30%">
                            <div class="progress" style="height:6px; background:rgba(255,255,255,0.1)">
                                <div class="progress-bar bg-primary" style="width:${percent}%"></div>
                            </div>
                        </td>
                        <td class="text-end fw-bold text-white">₱${loan.balance.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rowsHtml;

            document.getElementById('summaryTotalBalance').innerText = '₱' + totalRec.toLocaleString();
            document.getElementById('summaryTotalPaid').innerText = '₱' + totalCol.toLocaleString();
            document.getElementById('summaryTotalInvestment').innerText = '₱' + totalCap.toLocaleString();
            document.getElementById('summaryTotalInterest').innerText = '₱' + totalInt.toLocaleString();

            renderCollectionStats();
            renderCharts(totalRec, totalCol, totalCap);
            window.checkUnpaidToday();
        };

        window.openProfile = (id) => {
            currentProfileId = id;
            const loan = loanData.find(l => l.id === id);
            const now = new Date();
            document.getElementById('p-pay-date').value = now.toLocaleDateString('en-CA');
            document.getElementById('p-payment-method').value = 'cash'; 
            document.getElementById('historyFilterType').value = 'all';
            document.getElementById('historyFilterDate').value = '';
            
            // Clean input fields when opening modal
            document.getElementById('p-pay-amount').value = '';
            document.getElementById('p-penalty-amount').value = '';
            
            updateProfileUI(loan.name, loan.loanDate, loan.balance);
            renderHistory(); 
            new bootstrap.Modal(document.getElementById('profileModal')).show();
        };

        function updateProfileUI(name, date, balance) {
            document.getElementById('p-name').innerText = name;
            document.getElementById('p-date').innerText = window.formatDate(date);
            document.getElementById('p-balance').innerText = '₱' + balance.toLocaleString();
        }

        window.renderHistory = () => {
            if (!currentProfileId) return;
            const loan = loanData.find(l => l.id === currentProfileId);
            const list = document.getElementById('p-history-list');
            list.innerHTML = '';
            
            const filterType = document.getElementById('historyFilterType').value;
            const filterDate = document.getElementById('historyFilterDate').value;

            let historyWithIndex = (loan.payments || []).map((p, index) => ({...p, originalIndex: index}));
            let displayHistory = [...historyWithIndex].reverse();

            if (filterType !== 'all') displayHistory = displayHistory.filter(p => p.type === filterType);
            if (filterDate) displayHistory = displayHistory.filter(p => p.date === filterDate);
            
            displayHistory.forEach(p => {
                const isPay = p.type === 'payment';
                let methodIcon = '';
                if(isPay) {
                    if(p.method === 'online') {
                        methodIcon = '<i class="fas fa-mobile-alt text-primary me-2" title="GCash/Online"></i>';
                    } else {
                        methodIcon = '<i class="fas fa-money-bill-wave text-success me-2" title="Cash"></i>';
                    }
                }

                list.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center p-3 mb-2 rounded" style="background:rgba(255,255,255,0.03); border-left: 3px solid ${isPay ? '#10b981' : '#ef4444'}">
                        <div>
                            <div class="fw-bold text-white">
                                ${methodIcon}
                                ${isPay ? 'Payment Received' : 'Penalty Added'}
                            </div>
                            <small class="history-date">${window.formatDate(p.date)}</small>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="fw-bold ${isPay ? 'text-success' : 'text-danger'}">
                                ${isPay ? '+' : '+'}₱${p.amount.toLocaleString()}
                            </div>
                            <button onclick="deleteTransaction(${p.originalIndex})" class="btn-icon-del">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            if (displayHistory.length === 0) {
                list.innerHTML = '<p class="text-muted text-center mt-4">No transactions found.</p>';
            }
        }

        window.filterTable = () => {
            const term = document.getElementById('filterUtang').value.toLowerCase();
            const rows = document.querySelectorAll('#utangListBody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function renderCharts(bal, col, cap) {
            const ctx1 = document.getElementById('financeChart');
            if(chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Balance', 'Collected', 'Capital'],
                    datasets: [{ label: 'Amount', data: [bal, col, cap], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'] }]
                },
                options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{color:'rgba(255,255,255,0.05)'}}} }
            });

            const ctx2 = document.getElementById('statusChart');
            if(chart2) chart2.destroy();
            chart2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Collected'],
                    datasets: [{ data: [bal, col], backgroundColor: ['#3b82f6', '#10b981'], borderWidth:0 }]
                },
                options: { cutout: '70%', plugins:{legend:{position:'bottom'}} }
            });
        }

        window.downloadPDF = () => {
            if (!window.jspdf) { alert("Library not loaded!"); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const formatNumber = (num) => num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            doc.setFontSize(22); doc.setTextColor(40, 40, 40);
            doc.text('LendingMaster Report', 14, 20);
            doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 26);
            
            let totalInvestment = 0, totalBalance = 0, totalPaid = 0;
            loanData.forEach(loan => {
                totalInvestment += loan.initialLoan;
                totalBalance += loan.balance;
                totalPaid += (loan.payments || []).filter(p => p.type === 'payment').reduce((a,b) => a + b.amount, 0);
            });

            doc.autoTable({
                startY: 35,
                head: [['Total Investment', 'Total Collected', 'Outstanding Balance']],
                body: [[formatNumber(totalInvestment), formatNumber(totalPaid), formatNumber(totalBalance)]],
                theme: 'grid',
                headStyles: { fillColor: [37, 99, 235] },
                styles: { halign: 'center' }
            });

            const rows = loanData.map(u => [
                u.name, window.formatDate(u.loanDate),
                formatNumber(u.totalLoan), formatNumber(u.totalLoan - u.balance), formatNumber(u.balance)
            ]);

            doc.text('Borrower Status', 14, doc.lastAutoTable.finalY + 15);
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 20,
                head: [['Name', 'Date', 'Total Loan', 'Paid', 'Balance']],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [30, 41, 59] }
            });

            doc.save("LendingMaster_Report.pdf");
        }

        // --- NOTIFICATION LOGIC ---
        window.checkUnpaidToday = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            const unpaidList = loanData.filter(loan => {
                if (loan.balance <= 0) return false;
                const hasPaidToday = (loan.payments || []).some(p => 
                    p.type === 'payment' && p.date === todayStr
                );
                return !hasPaidToday;
            });

            const badge = document.getElementById('notif-badge');
            const bellIcon = document.querySelector('.fa-bell');

            if (unpaidList.length > 0) {
                badge.innerText = unpaidList.length;
                badge.classList.remove('hidden');
                bellIcon.classList.add('bell-ringing');
            } else {
                badge.classList.add('hidden');
                bellIcon.classList.remove('bell-ringing');
            }

            return unpaidList;
        };

        // --- CLICKABLE & SCROLLABLE LIST ---
        window.showUnpaidNotif = () => {
            const list = window.checkUnpaidToday();

            if (list.length === 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'All Collected!',
                    text: 'Lahat ng active borrowers ay nagbayad na today.',
                    background: '#161b2c',
                    color: 'white'
                });
                return;
            }

            // Fixed Height (250px ~ 5 rows) + Click Handler
            let htmlList = `<div class="text-start bg-dark p-2 rounded border border-secondary custom-scroll" style="max-height: 250px; overflow-y: auto;">`;
            list.forEach(u => {
                htmlList += `
                    <div onclick="openProfile('${u.id}'); Swal.close();" class="unpaid-row d-flex justify-content-between align-items-center p-2">
                        <span class="text-white fw-bold">${u.name}</span>
                        <span class="text-danger small">Bal: ₱${u.balance.toLocaleString()}</span>
                    </div>
                `;
            });
            htmlList += `</div>`;

            Swal.fire({
                title: `<strong>${list.length} Unpaid Today</strong>`,
                html: htmlList,
                icon: 'warning',
                background: '#161b2c',
                color: 'white',
                confirmButtonText: 'Close'
            });
        };
    </script>
</body>
</html>
